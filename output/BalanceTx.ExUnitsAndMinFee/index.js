// Generated by purs version 0.14.5
"use strict";
var BalanceTx_Error = require("../BalanceTx.Error/index.js");
var BalanceTx_Helpers = require("../BalanceTx.Helpers/index.js");
var BalanceTx_Types = require("../BalanceTx.Types/index.js");
var Cardano_Types_ScriptRef = require("../Cardano.Types.ScriptRef/index.js");
var Cardano_Types_Transaction = require("../Cardano.Types.Transaction/index.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_Error_Class = require("../Control.Monad.Error.Class/index.js");
var Control_Monad_Except_Trans = require("../Control.Monad.Except.Trans/index.js");
var Control_Monad_Reader_Class = require("../Control.Monad.Reader.Class/index.js");
var Control_Monad_Trans_Class = require("../Control.Monad.Trans.Class/index.js");
var Data_Array = require("../Data.Array/index.js");
var Data_Bifunctor = require("../Data.Bifunctor/index.js");
var Data_BigInt = require("../Data.BigInt/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Eq = require("../Data.Eq/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Function = require("../Data.Function/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Lens_Getter = require("../Data.Lens.Getter/index.js");
var Data_Lens_Index = require("../Data.Lens.Index/index.js");
var Data_Lens_Internal_Forget = require("../Data.Lens.Internal.Forget/index.js");
var Data_Lens_Setter = require("../Data.Lens.Setter/index.js");
var Data_Map_Internal = require("../Data.Map.Internal/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Monoid = require("../Data.Monoid/index.js");
var Data_Newtype = require("../Data.Newtype/index.js");
var Data_Ord = require("../Data.Ord/index.js");
var Data_Profunctor_Choice = require("../Data.Profunctor.Choice/index.js");
var Data_Profunctor_Strong = require("../Data.Profunctor.Strong/index.js");
var Data_Semigroup = require("../Data.Semigroup/index.js");
var Data_Set = require("../Data.Set/index.js");
var Data_Traversable = require("../Data.Traversable/index.js");
var Data_Tuple = require("../Data.Tuple/index.js");
var Data_Unfoldable = require("../Data.Unfoldable/index.js");
var Effect = require("../Effect/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Effect_Class = require("../Effect.Class/index.js");
var QueryM = require("../QueryM/index.js");
var QueryM_MinFee = require("../QueryM.MinFee/index.js");
var ReindexRedeemers = require("../ReindexRedeemers/index.js");
var Serialization = require("../Serialization/index.js");
var Transaction = require("../Transaction/index.js");
var Types_Natural = require("../Types.Natural/index.js");
var Types_RedeemerTag = require("../Types.RedeemerTag/index.js");
var Types_Scripts = require("../Types.Scripts/index.js");
var Types_Transaction = require("../Types.Transaction/index.js");
var Types_UnbalancedTransaction = require("../Types.UnbalancedTransaction/index.js");
var Untagged_Union = require("../Untagged.Union/index.js");
var setRdmrsExecutionUnits = function (rs) {
    return function (v) {
        var v1 = Data_Array.uncons(Data_Map_Internal.toUnfoldable(Data_Unfoldable.unfoldableArray)(v));
        if (v1 instanceof Data_Maybe.Nothing) {
            return rs;
        };
        if (v1 instanceof Data_Maybe.Just) {
            var xsWrapped = Data_Map_Internal.fromFoldable(Data_Ord.ordRecord()(Data_Ord.ordRecordCons(Data_Ord.ordRecordCons(Data_Ord.ordRecordNil)()({
                reflectSymbol: function () {
                    return "redeemerTag";
                }
            })(Types_RedeemerTag.ordRedeemerTag))()({
                reflectSymbol: function () {
                    return "redeemerIndex";
                }
            })(Types_Natural.ordNatural)))(Data_Foldable.foldableArray)(v1.value0.tail);
            var ixMaybe = Data_Function.flip(Data_Array.findIndex)(rs)(function (v2) {
                return Data_Eq.eq(Types_RedeemerTag.eqRedeemerTag)(v2.value0.tag)(v1.value0.head.value0.redeemerTag) && Data_Eq.eq(Data_BigInt.eqBigInt)(v2.value0.index)(Types_Natural.toBigInt(v1.value0.head.value0.redeemerIndex));
            });
            return Data_Maybe.maybe(setRdmrsExecutionUnits(rs)(xsWrapped))(function (ix) {
                return Data_Function.flip(setRdmrsExecutionUnits)(xsWrapped)(Data_Lens_Setter.over(Data_Lens_Index.ix(Data_Lens_Index.indexArray)(ix)(Data_Profunctor_Strong.strongFn)(Data_Profunctor_Choice.choiceFn))(function (v2) {
                    var steps = Types_Natural.toBigInt(v1.value0.head.value1.steps);
                    var mem = Types_Natural.toBigInt(v1.value0.head.value1.memory);
                    return new Data_Tuple.Tuple({
                        tag: v2.value0.tag,
                        index: v2.value0.index,
                        data: v2.value0.data,
                        exUnits: {
                            mem: mem,
                            steps: steps
                        }
                    }, v2.value1);
                })(rs));
            })(ixMaybe);
        };
        throw new Error("Failed pattern match at BalanceTx.ExUnitsAndMinFee (line 176, column 3 - line 192, column 70): " + [ v1.constructor.name ]);
    };
};
var updateTxExecutionUnits = function (unattachedTx) {
    return function (rdmrPtrExUnitsList) {
        return Data_Lens_Setter.over(BalanceTx_Helpers["_redeemersTxIns"](Data_Profunctor_Strong.strongFn))(Data_Function.flip(setRdmrsExecutionUnits)(rdmrPtrExUnitsList))(unattachedTx);
    };
};
var reindexRedeemers = function (v) {
    var inputs = Data_Array.fromFoldable(Data_Set.foldableSet)(Data_Lens_Getter.viewOn(v)((function () {
        var $44 = BalanceTx_Helpers["_body'"](Data_Lens_Internal_Forget.strongForget);
        var $45 = Cardano_Types_Transaction["_inputs"](Data_Lens_Internal_Forget.strongForget);
        return function ($46) {
            return $44($45($46));
        };
    })()));
    return Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(ReindexRedeemers["reindexSpentScriptRedeemers'"](inputs)(v.redeemersTxIns))(Data_Functor.map(Data_Either.functorEither)(function (redeemersTxInsReindexed) {
        return Data_Lens_Setter.set(BalanceTx_Helpers["_redeemersTxIns"](Data_Profunctor_Strong.strongFn))(redeemersTxInsReindexed)(v);
    }));
};
var reattachDatumsAndRedeemers = function (v) {
    var transaction = Data_Lens_Getter.viewOn(v.unbalancedTx)(Types_UnbalancedTransaction["_transaction"](Data_Lens_Internal_Forget.strongForget));
    return Data_Lens_Setter.setJust((function () {
        var $47 = Cardano_Types_Transaction["_witnessSet"](Data_Profunctor_Strong.strongFn);
        var $48 = Cardano_Types_Transaction["_redeemers"](Data_Profunctor_Strong.strongFn);
        return function ($49) {
            return $47($48($49));
        };
    })())(Data_Functor.map(Data_Functor.functorArray)(Data_Tuple.fst)(v.redeemersTxIns))(Data_Lens_Setter.setJust((function () {
        var $50 = Cardano_Types_Transaction["_witnessSet"](Data_Profunctor_Strong.strongFn);
        var $51 = Cardano_Types_Transaction["_plutusData"](Data_Profunctor_Strong.strongFn);
        return function ($52) {
            return $50($51($52));
        };
    })())(Data_Functor.map(Data_Functor.functorArray)(Data_Newtype.unwrap())(v.datums))(transaction));
};
var finalizeTransaction = function (reindexedUnattachedTxWithExUnits) {
    return function (utxos) {
        var getPlutusScript = function (v) {
            return Control_Bind.bindFlipped(Data_Maybe.bindMaybe)(Cardano_Types_ScriptRef.getPlutusScript)(v.scriptRef);
        };
        var getRefPlutusScripts = function (v) {
            var spendAndRefInputs = Data_Array.fromFoldable(Data_Set.foldableSet)(Data_Semigroup.append(Data_Set.semigroupSet(Types_Transaction.ordTransactionInput))(v.inputs)(v.referenceInputs));
            return Data_Maybe.fromMaybe(Data_Monoid.mempty(Data_Monoid.monoidArray))(Data_Functor.map(Data_Maybe.functorMaybe)((function () {
                var $53 = Data_Functor.map(Data_Functor.functorArray)(getPlutusScript);
                return function ($54) {
                    return Data_Array.catMaybes($53($54));
                };
            })())(Data_Traversable.traverse(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Function.flip(Data_Map_Internal.lookup(Types_Transaction.ordTransactionInput))(utxos))(spendAndRefInputs)));
        };
        var txBody = Data_Lens_Getter.viewOn(reindexedUnattachedTxWithExUnits)(BalanceTx_Helpers["_body'"](Data_Lens_Internal_Forget.strongForget));
        var attachedTxWithExUnits = reattachDatumsAndRedeemers(reindexedUnattachedTxWithExUnits);
        var ws = Data_Newtype.unwrap()(Data_Lens_Getter.viewOn(attachedTxWithExUnits)(Cardano_Types_Transaction["_witnessSet"](Data_Lens_Internal_Forget.strongForget)));
        var datums = Data_Functor.map(Data_Functor.functorArray)(Data_Newtype.wrap())(Data_Maybe.fromMaybe(Data_Monoid.mempty(Data_Monoid.monoidArray))(ws.plutusData));
        var redeemers = Data_Maybe.fromMaybe(Data_Monoid.mempty(Data_Monoid.monoidArray))(ws.redeemers);
        var scripts = Data_Semigroup.append(Data_Semigroup.semigroupArray)(Data_Maybe.fromMaybe(Data_Monoid.mempty(Data_Monoid.monoidArray))(ws.plutusScripts))(getRefPlutusScripts(txBody));
        var languages = Data_Foldable.foldMap(Data_Foldable.foldableArray)(Data_Set.monoidSet(Types_Scripts.ordLanguage))((function () {
            var $55 = Data_Newtype.unwrap();
            return function ($56) {
                return Data_Set.singleton(Data_Tuple.snd($55($56)));
            };
        })())(scripts);
        return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(Data_Functor.mapFlipped(Data_Functor.functorFn)(function ($57) {
            return (function (v) {
                return v.pparams;
            })((function (v) {
                return v.runtime;
            })($57));
        })((function () {
            var $58 = Data_Newtype.wrap();
            var $59 = Data_Map_Internal.filterKeys(Types_Scripts.ordLanguage)(Data_Function.flip(Data_Set.member(Types_Scripts.ordLanguage))(languages));
            var $60 = Data_Newtype.unwrap();
            var $61 = Data_Newtype.unwrap();
            return function ($62) {
                return $58($59($60((function (v) {
                    return v.costModels;
                })($61($62)))));
            };
        })())))(function (costModels) {
            return Effect_Class.liftEffect(QueryM.monadEffectQueryMExtended)(Data_Functor.map(Effect.functorEffect)(BalanceTx_Types.FinalizedTransaction)(Transaction.setScriptDataHash(costModels)(redeemers)(datums)(attachedTxWithExUnits)));
        });
    };
};
var evalTxExecutionUnits = function (tx) {
    return function (unattachedTx) {
        return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(Effect_Class.liftEffect(Control_Monad_Except_Trans.monadEffectExceptT(QueryM.monadEffectQueryMExtended))(Data_Functor.map(Effect.functorEffect)((function () {
            var $63 = Data_Newtype.wrap();
            var $64 = Untagged_Union.asOneOf();
            return function ($65) {
                return $63(Serialization.toBytes($64($65)));
            };
        })())(Serialization.convertTransaction(tx))))(function (txBytes) {
            return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(Data_Functor.map(Control_Monad_Except_Trans.functorExceptT(QueryM.functorQueryMExtended(Effect_Aff.functorAff)))(Data_Newtype.unwrap())(Control_Monad_Trans_Class.lift(Control_Monad_Except_Trans.monadTransExceptT)(QueryM.monadQueryMExtendedAff)(QueryM.evaluateTxOgmios(txBytes))))(function (eResult) {
                if (eResult instanceof Data_Either.Right) {
                    return Control_Applicative.pure(Control_Monad_Except_Trans.applicativeExceptT(QueryM.monadQueryMExtendedAff))(eResult.value0);
                };
                if (eResult instanceof Data_Either.Left && Data_Lens_Getter.viewOn(tx)(Cardano_Types_Transaction["_isValid"](Data_Lens_Internal_Forget.strongForget))) {
                    return Control_Monad_Error_Class.throwError(Control_Monad_Except_Trans.monadThrowExceptT(QueryM.monadQueryMExtendedAff))(new BalanceTx_Error.ExUnitsEvaluationFailed(unattachedTx, eResult.value0));
                };
                if (eResult instanceof Data_Either.Left) {
                    return Control_Applicative.pure(Control_Monad_Except_Trans.applicativeExceptT(QueryM.monadQueryMExtendedAff))(Data_Newtype.wrap()(Data_Map_Internal.empty));
                };
                throw new Error("Failed pattern match at BalanceTx.ExUnitsAndMinFee (line 74, column 3 - line 78, column 38): " + [ eResult.constructor.name ]);
            });
        });
    };
};
var evalExUnitsAndMinFee = function (v) {
    return function (allUtxos) {
        return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(Control_Monad_Except_Trans.ExceptT(Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(reindexRedeemers(v))(Data_Bifunctor.lmap(Data_Bifunctor.bifunctorEither)(BalanceTx_Error.ReindexRedeemersError.create))))(function (reindexedUnattachedTx) {
            var attachedTx = reattachDatumsAndRedeemers(reindexedUnattachedTx);
            return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(evalTxExecutionUnits(attachedTx)(reindexedUnattachedTx))(function (rdmrPtrExUnitsList) {
                var reindexedUnattachedTxWithExUnits = updateTxExecutionUnits(reindexedUnattachedTx)(rdmrPtrExUnitsList);
                return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(Control_Monad_Trans_Class.lift(Control_Monad_Except_Trans.monadTransExceptT)(QueryM.monadQueryMExtendedAff)(finalizeTransaction(reindexedUnattachedTxWithExUnits)(allUtxos)))(function (v1) {
                    return Control_Bind.bind(Control_Monad_Except_Trans.bindExceptT(QueryM.monadQueryMExtendedAff))(Control_Monad_Except_Trans.ExceptT(Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(QueryM_MinFee.calculateMinFee(v1))((function () {
                        var $66 = Control_Applicative.pure(Data_Either.applicativeEither);
                        var $67 = Data_Newtype.unwrap();
                        return function ($68) {
                            return $66($67($68));
                        };
                    })())))(function (minFee) {
                        return Control_Applicative.pure(Control_Monad_Except_Trans.applicativeExceptT(QueryM.monadQueryMExtendedAff))(new Data_Tuple.Tuple(reindexedUnattachedTxWithExUnits, minFee));
                    });
                });
            });
        });
    };
};
module.exports = {
    evalExUnitsAndMinFee: evalExUnitsAndMinFee,
    finalizeTransaction: finalizeTransaction
};
