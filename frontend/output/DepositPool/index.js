// Generated by purs version 0.14.5
"use strict";
var BondedStaking_TimeUtils = require("../BondedStaking.TimeUtils/index.js");
var Contract_Address = require("../Contract.Address/index.js");
var Contract_Log = require("../Contract.Log/index.js");
var Contract_Monad = require("../Contract.Monad/index.js");
var Contract_PlutusData = require("../Contract.PlutusData/index.js");
var Contract_Prelude = require("../Contract.Prelude/index.js");
var Contract_Utxos = require("../Contract.Utxos/index.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Data_Array = require("../Data.Array/index.js");
var Data_BigInt = require("../Data.BigInt/index.js");
var Data_Eq = require("../Data.Eq/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Function = require("../Data.Function/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Map_Internal = require("../Data.Map.Internal/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Monoid = require("../Data.Monoid/index.js");
var Data_Newtype = require("../Data.Newtype/index.js");
var Data_Ord = require("../Data.Ord/index.js");
var Data_Semigroup = require("../Data.Semigroup/index.js");
var Data_Semiring = require("../Data.Semiring/index.js");
var Data_Show = require("../Data.Show/index.js");
var Data_Traversable = require("../Data.Traversable/index.js");
var Data_Tuple = require("../Data.Tuple/index.js");
var Data_Unit = require("../Data.Unit/index.js");
var FromData = require("../FromData/index.js");
var Plutus_Conversion_Address = require("../Plutus.Conversion.Address/index.js");
var Plutus_Types_Address = require("../Plutus.Types.Address/index.js");
var Plutus_Types_Transaction = require("../Plutus.Types.Transaction/index.js");
var Plutus_Types_Value = require("../Plutus.Types.Value/index.js");
var Scripts = require("../Scripts/index.js");
var Scripts_PoolValidator = require("../Scripts.PoolValidator/index.js");
var Serialization_Address = require("../Serialization.Address/index.js");
var Settings = require("../Settings/index.js");
var ToData = require("../ToData/index.js");
var Types = require("../Types/index.js");
var Types_Datum = require("../Types.Datum/index.js");
var Types_Interval = require("../Types.Interval/index.js");
var Types_Natural = require("../Types.Natural/index.js");
var Types_PubKeyHash = require("../Types.PubKeyHash/index.js");
var Types_Rational = require("../Types.Rational/index.js");
var Types_Redeemer = require("../Types.Redeemer/index.js");
var Types_ScriptLookups = require("../Types.ScriptLookups/index.js");
var Types_Scripts = require("../Types.Scripts/index.js");
var Types_TokenName = require("../Types.TokenName/index.js");
var Types_Transaction = require("../Types.Transaction/index.js");
var Types_TxConstraints = require("../Types.TxConstraints/index.js");
var Utils = require("../Utils/index.js");
var calculateRewards = function (interest) {
    return function (deposited) {
        return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Control_Applicative.when(Contract_Monad.applicativeContract)(Data_Eq.eq(Data_BigInt.eqBigInt)(deposited)(Data_Semiring.zero(Data_BigInt.semiringBigInt)))(Contract_Monad.throwContractError(Data_Show.showString)("calculateRewards: totalDeposited is zero")))(function () {
            var recentRewards = Data_Semiring.mul(Types_Rational.semiringRational)(interest)(Utils.mkRatUnsafe(Types_Rational.reduce(Types_Rational.rationalComponentBigInt)(deposited)(Data_Semiring.one(Data_BigInt.semiringBigInt))));
            return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Control_Applicative.when(Contract_Monad.applicativeContract)(Data_Ord.lessThan(Types_Rational.ordRational)(recentRewards)(Data_Semiring.zero(Types_Rational.semiringRational)))(Contract_Monad.throwContractError(Data_Show.showString)("calculateRewards: invalid rewards amount")))(function () {
                return Control_Applicative.pure(Contract_Monad.applicativeContract)(recentRewards);
            });
        });
    };
};
var mkEntryUpdateList = function (v) {
    return function (valHash) {
        return function (v1) {
            return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("mkEntryUpdateList: Could not get Entry Datum Hash")(Utils.getUtxoDatumHash(v1.value1.value1)))(function (dHash) {
                return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_Transaction.showDataHash)("mkEntryUpdateList: datum hash")(dHash))(function () {
                    return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("mkEntryUpdateList: Cannot get Entry's datum")(Contract_PlutusData.getDatumByHash(dHash)))(function (listDatum) {
                        return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("mkEntryUpdateList: Cannot extract NFT State datum")(FromData.fromData(Types.fromDataBondedStakingDatu)(Data_Newtype.unwrap()(listDatum))))(function (v2) {
                            if (v2 instanceof Types.EntryDatum) {
                                var e = Data_Newtype.unwrap()(v2.value0.entry);
                                return Control_Bind.bind(Contract_Monad.bindContract)(calculateRewards(v.interest)(e.deposited))(function (calculatedRewards) {
                                    return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("mkEntryUpdateList: Could not create token name for user")(Types_TokenName.mkTokenName(e.key)))(function (assocListTn) {
                                        var valRedeemer = Types_Redeemer.Redeemer(ToData.toData(Types.toDataBondedStakingAction)(Types.AdminAct.value));
                                        var recentRewards = Utils.roundUp(calculatedRewards);
                                        var updatedDeposited = Data_Semiring.add(Data_BigInt.semiringBigInt)(e.deposited)(recentRewards);
                                        var newRewards = Data_Semiring.add(Types_Rational.semiringRational)(e.rewards)(Utils.mkRatUnsafe(Types_Rational.reduce(Types_Rational.rationalComponentBigInt)(recentRewards)(Data_Semiring.one(Data_BigInt.semiringBigInt))));
                                        var entryValue = Plutus_Types_Value.singleton(v.assocListCs)(assocListTn)(Data_Semiring.one(Data_BigInt.semiringBigInt));
                                        var entryDatum = Types_Datum.Datum(ToData.toData(Types.toDataBondedStakingDatum)(new Types.EntryDatum({
                                            entry: Types.Entry({
                                                key: e.key,
                                                newDeposit: Data_Semiring.zero(Data_BigInt.semiringBigInt),
                                                deposited: updatedDeposited,
                                                staked: updatedDeposited,
                                                rewards: newRewards,
                                                next: e.next
                                            })
                                        })));
                                        var assetParams = Data_Newtype.unwrap()(v.bondedAssetClass);
                                        var assetDatum = Types_Datum.Datum(ToData.toData(Types.toDataBondedStakingDatum)(Types.AssetDatum.value));
                                        var depositValue = Plutus_Types_Value.singleton(assetParams.currencySymbol)(assetParams.tokenName)(recentRewards);
                                        var constraints = Contract_Prelude.mconcat(Data_Foldable.foldableArray)(Types_TxConstraints.monoidTxConstraints)([ Utils.mustPayToScript(valHash)(assetDatum)(depositValue), Utils.mustPayToScript(valHash)(entryDatum)(entryValue), Types_TxConstraints.mustSpendScriptOutput(v1.value1.value0)(valRedeemer) ]);
                                        return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("mkEntryUpdateList: Could not create state datum lookup")(Types_ScriptLookups.datum(entryDatum)))(function (entryDatumLookup) {
                                            return Control_Applicative.pure(Contract_Monad.applicativeContract)(new Data_Tuple.Tuple(constraints, entryDatumLookup));
                                        });
                                    });
                                });
                            };
                            return Contract_Monad.throwContractError(Data_Show.showString)("mkEntryUpdateList: Datum not Entry constructor");
                        });
                    });
                });
            });
        };
    };
};
var depositBondedPoolContract = function (v) {
    return function (batchSize) {
        return function (depositList) {
            return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Address.getNetworkId)(function (networkId) {
                return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("depositBondedPoolContract: Cannot get user's pkh")(Contract_Address.ownPaymentPubKeyHash))(function (userPkh) {
                    return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Control_Applicative.unless(Contract_Monad.applicativeContract)(Data_Eq.eq(Types_PubKeyHash.eqPaymentPubKeyHash)(userPkh)(v.admin))(Contract_Monad.throwContractError(Data_Show.showString)("depositBondedPoolContract: Admin is not current user")))(function () {
                        return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_PubKeyHash.showPaymentPubKeyHash)("depositBondedPoolContract: Admin PaymentPubKeyHash")(userPkh))(function () {
                            return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("depositBondedPoolContract: Cannot get wallet Address")(Contract_Address.getWalletAddress))(function (adminAddr) {
                                return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("depositBondedPoolContract: Cannot get user Utxos")(Contract_Utxos.utxosAt(adminAddr)))(function (adminUtxos) {
                                    return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad["liftedE'"]("depositBondedPoolContract: Cannot create validator")(Scripts_PoolValidator.mkBondedPoolValidator(v)))(function (validator) {
                                        var valHash = Scripts.validatorHash(validator);
                                        return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_Scripts.showValidatorHash)("depositBondedPoolContract: validatorHash")(valHash))(function () {
                                            var poolAddr = Plutus_Types_Address.scriptHashAddress(valHash);
                                            return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Serialization_Address.showAddress)("depositBondedPoolContract: Pool address")(Plutus_Conversion_Address.fromPlutusAddress(networkId)(poolAddr)))(function () {
                                                return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("depositBondedPoolContract: Cannot get pool's utxos at pool address")(Contract_Utxos.utxosAt(poolAddr)))(function (bondedPoolUtxos) {
                                                    return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Data_Map_Internal.showMap(Types_Transaction.showTransactionInput)(Plutus_Types_Transaction.showTransactionOutputWith))("depositBondedPoolContract: Pool UTXOs")(bondedPoolUtxos))(function () {
                                                        return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("depositBondedPoolContract: Cannot create TokenName")(Settings.bondedStakingTokenName))(function (tokenName) {
                                                            return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("depositBondedPoolContract: Cannot get state utxo")(Utils.getUtxoWithNFT(bondedPoolUtxos)(v.nftCs)(tokenName)))(function (v1) {
                                                                return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_Transaction.showTransactionInput)("depositBondedPoolContract: Pool's UTXO")(v1.value0))(function () {
                                                                    return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("depositBondedPoolContract: Could not get Pool UTXO's Datum Hash")(Utils.getUtxoDatumHash(v1.value1)))(function (poolDatumHash) {
                                                                        return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_Transaction.showDataHash)("depositBondedPoolContract: Pool's UTXO DatumHash")(poolDatumHash))(function () {
                                                                            return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftedM("depositBondedPoolContract: Cannot get datum")(Contract_PlutusData.getDatumByHash(poolDatumHash)))(function (poolDatum) {
                                                                                return Control_Bind.bind(Contract_Monad.bindContract)(Contract_Monad.liftContractM("depositBondedPoolContract: Cannot extract NFT State datum")(FromData.fromData(Types.fromDataBondedStakingDatu)(Data_Newtype.unwrap()(poolDatum))))(function (v2) {
                                                                                    return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Contract_Log["logInfo'"](Contract_Monad.monadLoggerContract)("depositBondedPoolContract: Getting bonding range..."))(function () {
                                                                                        return Control_Bind.bind(Contract_Monad.bindContract)(BondedStaking_TimeUtils.getBondingTime(v))(function (v3) {
                                                                                            return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Data_Show.showString)("depositBondedPoolContract: Current time: ")(Data_Show.show(Types_Interval.showPOSIXTime)(v3.currTime)))(function () {
                                                                                                return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Types_Interval.showInterval(Types_Interval.showPOSIXTime))("depositBondedPoolContract: TX Range")(v3.range))(function () {
                                                                                                    if (v2 instanceof Types.StateDatum && v2.value0.maybeEntryName instanceof Data_Maybe.Just) {
                                                                                                        return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Contract_Log["logInfo'"](Contract_Monad.monadLoggerContract)("depositBondedPoolContract: STAKE TYPE - StateDatum is StateDatum { maybeEntryName: Just ... }"))(function () {
                                                                                                            var lookups = Data_Semigroup.append(Types_ScriptLookups.semigroupScriptLookups)(Types_ScriptLookups.validator(validator))(Data_Semigroup.append(Types_ScriptLookups.semigroupScriptLookups)(Types_ScriptLookups.unspentOutputs(adminUtxos))(Types_ScriptLookups.unspentOutputs(bondedPoolUtxos)));
                                                                                                            var constraints = Data_Semigroup.append(Types_TxConstraints.semigroupTxConstraints)(Types_TxConstraints.mustBeSignedBy(v.admin))(Types_TxConstraints.mustValidateIn(v3.range));
                                                                                                            var assocList = Utils.mkOnchainAssocList(v.assocListCs)(bondedPoolUtxos);
                                                                                                            return Control_Bind.bind(Contract_Monad.bindContract)(Control_Bind.bind(Contract_Monad.bindContract)(Data_Traversable.traverse(Data_Traversable.traversableArray)(Contract_Monad.applicativeContract)(mkEntryUpdateList(v)(valHash))(assocList))(function (allConstraints) {
                                                                                                                var $29 = Data_Foldable["null"](Data_Foldable.foldableArray)(depositList);
                                                                                                                if ($29) {
                                                                                                                    return Control_Applicative.pure(Contract_Monad.applicativeContract)(allConstraints);
                                                                                                                };
                                                                                                                return Contract_Monad.liftContractM("depositBondedPoolContract: Failed to create updateList")(Data_Traversable.traverse(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Array.index(allConstraints))(depositList));
                                                                                                            }))(function (updateList) {
                                                                                                                return Control_Bind.bind(Contract_Monad.bindContract)((function () {
                                                                                                                    var $30 = Data_Eq.eq(Types_Natural.eqNatural)(batchSize)(Data_Semiring.zero(Types_Natural.semiringNatural));
                                                                                                                    if ($30) {
                                                                                                                        return Utils.submitTransaction(constraints)(lookups)(updateList)(Settings.confirmationTimeout)(Settings.submissionAttempts);
                                                                                                                    };
                                                                                                                    var updateBatches = Utils.splitByLength(Utils.toIntUnsafe(batchSize))(updateList);
                                                                                                                    return Data_Functor.map(Contract_Monad.functorContract)(Contract_Prelude.mconcat(Data_Foldable.foldableArray)(Data_Monoid.monoidArray))(Data_Traversable["for"](Contract_Monad.applicativeContract)(Data_Traversable.traversableArray)(updateBatches)(function (txBatch) {
                                                                                                                        return Utils.submitTransaction(constraints)(lookups)(txBatch)(Settings.confirmationTimeout)(Settings.submissionAttempts);
                                                                                                                    }));
                                                                                                                })())(function (failedDeposits) {
                                                                                                                    return Control_Bind.discard(Control_Bind.discardUnit)(Contract_Monad.bindContract)(Utils.logInfo_(Data_Show.showArray(Data_Tuple.showTuple(Types_TxConstraints.showTxConstraints(Data_Unit.showUnit)(Data_Unit.showUnit))(Types_ScriptLookups.showScriptLookups)))("depositBondedPoolContract: Finished updating pool entries. /Entries with failed updates")(failedDeposits))(function () {
                                                                                                                        return Contract_Monad.liftContractM("depositUnbondedPoolContract: Failed to create /failedDepositsIndicies list")(Data_Traversable.traverse(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Function.flip(Data_Array.elemIndex(Data_Tuple.eqTuple(Types_TxConstraints.eqTxConstraints(Data_Eq.eqUnit)(Data_Eq.eqUnit))(Types_ScriptLookups.eqScriptLookups)))(updateList))(failedDeposits));
                                                                                                                    });
                                                                                                                });
                                                                                                            });
                                                                                                        });
                                                                                                    };
                                                                                                    if (v2 instanceof Types.StateDatum && v2.value0.maybeEntryName instanceof Data_Maybe.Nothing) {
                                                                                                        return Contract_Monad.throwContractError(Data_Show.showString)("depositBondedPoolContract: There are no users in the pool to deposit rewards for");
                                                                                                    };
                                                                                                    return Contract_Monad.throwContractError(Data_Show.showString)("depositBondedPoolContract: Datum incorrect type");
                                                                                                });
                                                                                            });
                                                                                        });
                                                                                    });
                                                                                });
                                                                            });
                                                                        });
                                                                    });
                                                                });
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };
    };
};
module.exports = {
    depositBondedPoolContract: depositBondedPoolContract
};
