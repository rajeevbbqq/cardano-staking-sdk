// Generated by purs version 0.14.5
"use strict";
var Address = require("../Address/index.js");
var Cardano_Types_Value = require("../Cardano.Types.Value/index.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Control_Monad_Reader_Class = require("../Control.Monad.Reader.Class/index.js");
var Control_Monad_Reader_Trans = require("../Control.Monad.Reader.Trans/index.js");
var Data_Array = require("../Data.Array/index.js");
var Data_Bifunctor = require("../Data.Bifunctor/index.js");
var Data_Bitraversable = require("../Data.Bitraversable/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Function = require("../Data.Function/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_HeytingAlgebra = require("../Data.HeytingAlgebra/index.js");
var Data_List_Types = require("../Data.List.Types/index.js");
var Data_Map_Internal = require("../Data.Map.Internal/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Newtype = require("../Data.Newtype/index.js");
var Data_Ord = require("../Data.Ord/index.js");
var Data_Traversable = require("../Data.Traversable/index.js");
var Data_Tuple = require("../Data.Tuple/index.js");
var Data_UInt = require("../Data.UInt/index.js");
var Data_Unfoldable = require("../Data.Unfoldable/index.js");
var Effect_Aff = require("../Effect.Aff/index.js");
var Effect_Aff_Class = require("../Effect.Aff.Class/index.js");
var Effect_Class = require("../Effect.Class/index.js");
var Effect_Exception = require("../Effect.Exception/index.js");
var Helpers = require("../Helpers/index.js");
var QueryM = require("../QueryM/index.js");
var QueryM_Ogmios = require("../QueryM.Ogmios/index.js");
var TxOutput = require("../TxOutput/index.js");
var Types_Transaction = require("../Types.Transaction/index.js");
var Types_UsedTxOuts = require("../Types.UsedTxOuts/index.js");
var Wallet = require("../Wallet/index.js");
var withTxRefsCache = (function () {
    var $66 = Data_Newtype.wrap();
    var $67 = Control_Monad_Reader_Trans.withReaderT(function ($69) {
        return (function (v) {
            return v.usedTxOuts;
        })((function (v) {
            return v.runtime;
        })($69));
    });
    return function ($68) {
        return $66($67($68));
    };
})();
var getUtxo = function (ref) {
    var convertUtxos = function (v) {
        var out$prime = Data_Functor.mapFlipped(Data_Functor.functorArray)(Data_Map_Internal.toUnfoldable(Data_Unfoldable.unfoldableArray)(v))(Data_Bifunctor.bimap(Data_Bifunctor.bifunctorTuple)(TxOutput.txOutRefToTransactionInput)(TxOutput.ogmiosTxOutToTransactionOutput));
        var out = Data_Traversable.sequence(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Functor.mapFlipped(Data_Functor.functorArray)(out$prime)(Data_Bitraversable.bisequence(Data_Bitraversable.bitraversableTuple)(Data_Maybe.applicativeMaybe)));
        return Data_Functor.map(Data_Maybe.functorMaybe)(Data_Map_Internal.fromFoldable(Types_Transaction.ordTransactionInput)(Data_Foldable.foldableArray))(out);
    };
    return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(QueryM.mkOgmiosRequest(QueryM_Ogmios.queryUtxoCall)(function (v) {
        return v.utxo;
    })(ref))(function (res) {
        return Control_Applicative.pure(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Control_Bind.bind(Data_Maybe.bindMaybe)(convertUtxos(res))(Data_Map_Internal.lookup(Types_Transaction.ordTransactionInput)(ref)));
    });
};
var filterLockedUtxos = function (utxos) {
    return withTxRefsCache(Data_Function.flip(Helpers.filterMapWithKeyM(Types_Transaction.ordTransactionInput)(Control_Monad_Reader_Trans.monadReaderT(Effect_Aff.monadAff)))(utxos)(function (k) {
        return function (v) {
            return Data_Functor.map(Control_Monad_Reader_Trans.functorReaderT(Effect_Aff.functorAff))(Data_HeytingAlgebra.not(Data_HeytingAlgebra.heytingAlgebraBoolean))(Types_UsedTxOuts.isTxOutRefUsed(Control_Monad_Reader_Trans.monadAskReaderT(Effect_Aff.monadAff))(Control_Monad_Reader_Trans.monadEffectReader(Effect_Aff.monadEffectAff))(Data_Newtype.unwrap()(k)));
        };
    }));
};
var utxosAt = function (address) {
    return mkUtxoQuery(QueryM.mkOgmiosRequest(QueryM_Ogmios.queryUtxosAtCall)(function (v) {
        return v.utxosAt;
    })(Address.addressToOgmiosAddress(address)));
};
var mkUtxoQuery = function (query) {
    var allUtxosAt = (function () {
        var convertUtxos = function (v) {
            var out$prime = Data_Functor.mapFlipped(Data_Functor.functorArray)(Data_Map_Internal.toUnfoldable(Data_Unfoldable.unfoldableArray)(v))(Data_Bifunctor.bimap(Data_Bifunctor.bifunctorTuple)(TxOutput.txOutRefToTransactionInput)(TxOutput.ogmiosTxOutToTransactionOutput));
            var out = Data_Traversable.sequence(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe)(Data_Functor.mapFlipped(Data_Functor.functorArray)(out$prime)(Data_Bitraversable.bisequence(Data_Bitraversable.bitraversableTuple)(Data_Maybe.applicativeMaybe)));
            return Data_Functor.map(Data_Maybe.functorMaybe)(Data_Map_Internal.fromFoldable(Types_Transaction.ordTransactionInput)(Data_Foldable.foldableArray))(out);
        };
        return Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(convertUtxos)(query);
    })();
    var cip30UtxosAt = Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(getWalletCollateral)(Data_Maybe.maybe(Effect_Class.liftEffect(QueryM.monadEffectQueryMExtended)(Effect_Exception["throw"]("CIP-30 wallet missing collateral")))(function (collateralUtxos) {
        return Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(allUtxosAt)(function (utxos$prime) {
            return Data_Foldable.foldr(Data_Foldable.foldableArray)(function (collateralUtxo) {
                return function (utxoAcc) {
                    return Data_Functor.map(Data_Maybe.functorMaybe)(Data_Map_Internal["delete"](Types_Transaction.ordTransactionInput)((Data_Newtype.unwrap()(collateralUtxo)).input))(utxoAcc);
                };
            })(utxos$prime)(collateralUtxos);
        });
    }));
    var utxosAtByWallet = function (v) {
        if (v instanceof Wallet.Nami) {
            return cip30UtxosAt;
        };
        if (v instanceof Wallet.Gero) {
            return cip30UtxosAt;
        };
        if (v instanceof Wallet.Flint) {
            return cip30UtxosAt;
        };
        if (v instanceof Wallet.Eternl) {
            return cip30UtxosAt;
        };
        if (v instanceof Wallet.Lode) {
            return cip30UtxosAt;
        };
        if (v instanceof Wallet.KeyWallet) {
            return allUtxosAt;
        };
        throw new Error("Failed pattern match at QueryM.Utxos (line 96, column 21 - line 102, column 30): " + [ v.constructor.name ]);
    };
    return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($70) {
        return (function (v) {
            return v.wallet;
        })((function (v) {
            return v.runtime;
        })($70));
    }))(Data_Maybe.maybe(allUtxosAt)(utxosAtByWallet));
};
var getWalletCollateral = Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($71) {
    return (function (v) {
        return v.wallet;
    })((function (v) {
        return v.runtime;
    })($71));
}))(Data_Maybe.maybe(Control_Applicative.pure(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Data_Maybe.Nothing.value))(function (v) {
    if (v instanceof Wallet.Nami) {
        return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(QueryM.callCip30Wallet(v.value0)(function (v1) {
            return v1.getCollateral;
        }));
    };
    if (v instanceof Wallet.Gero) {
        return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(QueryM.callCip30Wallet(v.value0)(function (v1) {
            return v1.getCollateral;
        }));
    };
    if (v instanceof Wallet.Flint) {
        return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(QueryM.callCip30Wallet(v.value0)(function (v1) {
            return v1.getCollateral;
        }));
    };
    if (v instanceof Wallet.Lode) {
        return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(QueryM.callCip30Wallet(v.value0)(function (v1) {
            return v1.getCollateral;
        }));
    };
    if (v instanceof Wallet.Eternl) {
        return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(QueryM.callCip30Wallet(v.value0)(function (v1) {
            return v1.getCollateral;
        }));
    };
    if (v instanceof Wallet.KeyWallet) {
        return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($72) {
            return (function (v1) {
                return v1.networkId;
            })((function (v1) {
                return v1.config;
            })($72));
        }))(function (networkId) {
            return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)((Data_Newtype.unwrap()(v.value0)).address(networkId)))(function (addr) {
                return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(utxosAt(addr))(Data_Maybe.fromMaybe(Data_Map_Internal.empty)))(filterLockedUtxos))(function (utxos) {
                    return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(Data_Functor.mapFlipped(Data_Functor.functorFn)(function ($73) {
                        return (function (v1) {
                            return v1.pparams;
                        })((function (v1) {
                            return v1.runtime;
                        })($73));
                    })(Data_Newtype.unwrap())))(function (pparams) {
                        var maxCollateralInputs = Data_UInt.toInt(pparams.maxCollateralInputs);
                        return Effect_Class.liftEffect(QueryM.monadEffectQueryMExtended)((Data_Newtype.unwrap()(v.value0)).selectCollateral(pparams.coinsPerUtxoUnit)(maxCollateralInputs)(utxos));
                    });
                });
            });
        });
    };
    throw new Error("Failed pattern match at QueryM.Utxos (line 201, column 5 - line 219, column 16): " + [ v.constructor.name ]);
})))(function (mbCollateralUTxOs) {
    return Control_Bind.discard(Control_Bind.discardUnit)(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Data_Foldable.for_(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Data_Foldable.foldableMaybe)(mbCollateralUTxOs)(function (collateralUTxOs) {
        return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($74) {
            return (function (v) {
                return v.pparams;
            })((function (v) {
                return v.runtime;
            })($74));
        }))(function (pparams) {
            var tooManyCollateralUTxOs = Data_Ord.greaterThan(Data_UInt.uintOrd)(Data_UInt.fromInt(Data_Array.length(collateralUTxOs)))((Data_Newtype.unwrap()(pparams)).maxCollateralInputs);
            return Control_Applicative.when(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(tooManyCollateralUTxOs)(Effect_Class.liftEffect(QueryM.monadEffectQueryMExtended)(Effect_Exception["throw"]("Wallet returned too many UTxOs as collateral. This is likely a bug in the wallet.")));
        });
    }))(function () {
        return Control_Applicative.pure(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(mbCollateralUTxOs);
    });
});
var getWalletBalance = Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($75) {
    return (function (v) {
        return v.wallet;
    })((function (v) {
        return v.runtime;
    })($75));
}))((function () {
    var $76 = Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(Control_Bind.join(Data_Maybe.bindMaybe));
    var $77 = Data_Traversable.traverse(Data_Traversable.traversableMaybe)(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(function (v) {
        if (v instanceof Wallet.Nami) {
            return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(v.value0.getBalance(v.value0.connection));
        };
        if (v instanceof Wallet.Gero) {
            return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(v.value0.getBalance(v.value0.connection));
        };
        if (v instanceof Wallet.Eternl) {
            return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(v.value0.getBalance(v.value0.connection));
        };
        if (v instanceof Wallet.Flint) {
            return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(v.value0.getBalance(v.value0.connection));
        };
        if (v instanceof Wallet.Lode) {
            return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(v.value0.getBalance(v.value0.connection));
        };
        if (v instanceof Wallet.KeyWallet) {
            return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(QueryM.getWalletAddresses)(function (mbAddresses) {
                return Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(Control_Bind.join(Data_Maybe.bindMaybe))(Data_Traversable["for"](QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Data_Traversable.traversableMaybe)(mbAddresses)(function (addresses) {
                    return Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))((function () {
                        var $79 = Data_Functor.map(Data_Maybe.functorMaybe)(Data_Foldable.fold(Data_Foldable.foldableArray)(Cardano_Types_Value.monoidValue));
                        var $80 = Data_Traversable.sequence(Data_Traversable.traversableArray)(Data_Maybe.applicativeMaybe);
                        return function ($81) {
                            return $79($80($81));
                        };
                    })())(Data_Traversable["for"](QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Data_Traversable.traversableArray)(addresses)(function (address) {
                        return Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(utxosAt(address))(Data_Functor.map(Data_Maybe.functorMaybe)((function () {
                            var $82 = Data_Foldable.fold(Data_List_Types.foldableList)(Cardano_Types_Value.monoidValue);
                            var $83 = Data_Functor.map(Data_List_Types.functorList)(function (v1) {
                                return v1.amount;
                            });
                            var $84 = Data_Functor.map(Data_List_Types.functorList)(Data_Newtype.unwrap());
                            return function ($85) {
                                return $82($83($84(Data_Map_Internal.values($85))));
                            };
                        })()));
                    }));
                }));
            });
        };
        throw new Error("Failed pattern match at QueryM.Utxos (line 164, column 59 - line 178, column 66): " + [ v.constructor.name ]);
    });
    return function ($78) {
        return $76($77($78));
    };
})());
var getWalletUtxos = (function () {
    var toUtxoMap = (function () {
        var $86 = Data_Map_Internal.fromFoldable(Types_Transaction.ordTransactionInput)(Data_Foldable.foldableArray);
        var $87 = Data_Functor.map(Data_Functor.functorArray)((function () {
            var $89 = Data_Newtype.unwrap();
            return function ($90) {
                return (function (v) {
                    return new Data_Tuple.Tuple(v.input, v.output);
                })($89($90));
            };
        })());
        return function ($88) {
            return $86($87($88));
        };
    })();
    return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Control_Monad_Reader_Class.asks(QueryM.monadAskQueryEnvQueryMExt)(function ($91) {
        return (function (v) {
            return v.wallet;
        })((function (v) {
            return v.runtime;
        })($91));
    }))((function () {
        var $92 = Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(Control_Bind.join(Data_Maybe.bindMaybe));
        var $93 = Data_Traversable.traverse(Data_Traversable.traversableMaybe)(QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(function (v) {
            if (v instanceof Wallet.Nami) {
                return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(Data_Functor.mapFlipped(Effect_Aff.functorAff)(v.value0.getUtxos(v.value0.connection))(Data_Functor.map(Data_Maybe.functorMaybe)(toUtxoMap)));
            };
            if (v instanceof Wallet.Gero) {
                return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(Data_Functor.mapFlipped(Effect_Aff.functorAff)(v.value0.getUtxos(v.value0.connection))(Data_Functor.map(Data_Maybe.functorMaybe)(toUtxoMap)));
            };
            if (v instanceof Wallet.Flint) {
                return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(Data_Functor.mapFlipped(Effect_Aff.functorAff)(v.value0.getUtxos(v.value0.connection))(Data_Functor.map(Data_Maybe.functorMaybe)(toUtxoMap)));
            };
            if (v instanceof Wallet.Eternl) {
                return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(Data_Functor.mapFlipped(Effect_Aff.functorAff)(v.value0.getUtxos(v.value0.connection))(Data_Functor.map(Data_Maybe.functorMaybe)(toUtxoMap)));
            };
            if (v instanceof Wallet.Lode) {
                return Effect_Aff_Class.liftAff(QueryM.monadAffQueryMExtendedAff)(Data_Functor.mapFlipped(Effect_Aff.functorAff)(v.value0.getUtxos(v.value0.connection))(Data_Functor.map(Data_Maybe.functorMaybe)(toUtxoMap)));
            };
            if (v instanceof Wallet.KeyWallet) {
                return Control_Bind.bind(QueryM.bindQueryMExtended(Effect_Aff.bindAff))(Data_Functor.mapFlipped(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(QueryM.getWalletAddresses)(function (v1) {
                    return Control_Bind.bind(Data_Maybe.bindMaybe)(v1)(Data_Array.head);
                }))(function (mbAddress) {
                    return Data_Functor.map(QueryM.functorQueryMExtended(Effect_Aff.functorAff))(Control_Bind.join(Data_Maybe.bindMaybe))(Data_Traversable["for"](QueryM.applicativeQueryMExtended(Effect_Aff.applicativeAff))(Data_Traversable.traversableMaybe)(mbAddress)(utxosAt));
                });
            };
            throw new Error("Failed pattern match at QueryM.Utxos (line 182, column 59 - line 192, column 39): " + [ v.constructor.name ]);
        });
        return function ($94) {
            return $92($93($94));
        };
    })());
})();
module.exports = {
    filterLockedUtxos: filterLockedUtxos,
    getUtxo: getUtxo,
    getWalletBalance: getWalletBalance,
    utxosAt: utxosAt,
    getWalletCollateral: getWalletCollateral,
    getWalletUtxos: getWalletUtxos
};
